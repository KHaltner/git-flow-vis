"use strict";var GitFlowVisualize=function(){function e(t){var r={score:0},n=t.slice(0),a=n.length,s=n[a-1];r.members={};for(var o=null,i=0;i<n.length;i++)r.members[n[i]]=o,o=n[i];return r.push=function(e){var t=s;a++,r.members[e]=t,s=e,n.push(e)},r.last=function(){return s},r.clone=function(){var t=e(n);return t.score=r.score,t},r.asArray=function(){return n.slice(0)},r}var t,r={},n={style:"none",root:null},a={rowHeight:35},s=CryptoJS.MD5,o={drawElem:null,drawTable:!1,masterRef:"refs/heads/master",developRef:"refs/heads/develop",featurePrefix:"refs/heads/feature/",releasePrefix:"refs/heads/release/",hotfixPrefix:"refs/heads/hotfix/",releaseZonePattern:/^refs\/heads\/bugfix/,releaseTagPattern:/refs\/tags\/\d+(\.\d+)+$/,showSpinner:function(){},hideSpinner:function(){},dataCallback:function(e){console.log("The required option 'dataCallback' is missing, please provide a method to retrieve commit data"),e({})},moreDataCallback:function(e,t){console.log("The required option 'moreDataCallback' is missing, please provide a method to retrieve commit data"),t({})},dataProcessed:function(){},createCommitUrl:function(){return"#"},createAuthorAvatarUrl:function(e){return"https://secure.gravatar.com/avatar/"+s(e.emailAddress)+".jpg?s=48&amp;d=mm"},hiddenBranches:[]},i=function(e){var r={};if(t=r,r.commits={},r.openEnds={},!e.commits||!e.branches||!e.tags)throw"raw data should have a commits, branches and  tags property";for(var n=0;n<e.commits.length;n++)for(var a=0;a<e.commits[n].values.length;a++){var s=e.commits[n].values[a];delete s.columns,delete s.labels,delete s.orderTimestamp,delete s.children,r.commits[s.id]=s}for(var i in r.commits){var s=r.commits[i];s.orderTimestamp=s.authorTimestamp,s.children||(s.children=[]);for(var n=s.parents.length-1;n>=0;n--){var m=r.commits[s.parents[n].id];m?l(m,s.id):(r.openEnds[s.id]=r.openEnds[s.id]||[],r.openEnds[s.id].push(s.parents[n].id))}}r.branches=_.filter(e.branches.values,function(e){return o.hiddenBranches.indexOf(e.id)===-1});for(var n=0;n<r.branches.length;n++){var d=r.branches[n],s=r.commits[d.latestChangeset];s&&(s.labels=s.labels||[],s.labels.push(d.id))}var u=function(e,t){if(e&&e.orderTimestamp<=t){e.orderTimestamp=t+1;for(var n=0;n<e.children.length;n++)u(r.commits[e.children[n]],e.orderTimestamp)}};for(var f in r.commits)for(var h=r.commits[f],g=0;g<h.parents.length;g++){var m=r.commits[h.parents[g].id];m&&u(h,m.orderTimestamp)}r.tags=e.tags.values;for(var n=0;n<r.tags.length;n++){var p=r.tags[n],s=r.commits[p.latestChangeset];s&&(s.labels=s.labels||[],s.labels.push(p.id))}r.labels=r.tags.concat(r.branches),r.chronoCommits=[];for(var i in r.commits)r.chronoCommits.push(i);r.chronoCommits.sort(function(e,t){return r.commits[t].orderTimestamp-r.commits[e].orderTimestamp});for(var n=0;n<r.chronoCommits.length;n++)r.commits[r.chronoCommits[n]].orderNr=n;return c(r),r},l=function(e,t){e.children=e.children||[],e.children.push(t)},c=function(){m(),d(),u(),f(),h("d"),h("f"),h("r")},m=function(){var e=_.filter(t.branches,function(e){return e.id==o.masterRef});if(0!=e.length){for(var r=p(e[0].latestChangeset,_.map(_.filter(t.tags,function(e){return e.id.match(o.releaseTagPattern)}),function(e){return e.latestChangeset}),t),n=0;n<r.length;n++)g(r[n],"m",t);for(;;){var a=t.columns.m.commits,s=a[a.length-1],i=t.commits[s].parents;if(!i||0==i.length)break;if(!g(i[0].id,"m",t))break}}},d=function(){var e=_.filter(t.branches,function(e){return e.id==o.developRef});if(0!=e.length){for(var r=b(e[0].latestChangeset),n=0;n<r.length;n++)g(r[n],"d0",t);for(var a=o.developRef.substring(o.developRef.lastIndexOf("/")+1),s=new RegExp("Merge branch '[^']+' (of \\S+ )?into "+a+"$"),i=1,n=0;n<t.chronoCommits.length;n++){var l=t.commits[t.chronoCommits[n]];l.columns||s.test(l.message)&&(g(l.id,"d"+i),i++)}}},u=function(){for(var e=0,r=0;r<t.chronoCommits.length;r++){var n=t.commits[t.chronoCommits[r]];if(!n.columns){var a=_.filter(n.children,function(e){var r=t.commits[e],n=r.columns&&("m"==r.columns[0]||"d"==r.columns[0][0]);if(n)return!1;t.columns[r.columns[0]]||console.log("huh");var a=t.columns[r.columns[0]].commits;return r.id==a[a.length-1]});if(0==a.length)g(n.id,"c"+e,t),e++;else{var s=t.commits[a[0]];s&&s.columns?(g(n.id,s.columns[0],t),s._hasColumnChild=!0):console.log("Couldn't find appropriate parent")}}}},f=function(){for(var e in t.columns){var r=t.columns[e];if("m"!=e&&"d"!=e[0]){var n=_.flatMap(r.commits,function(e){return t.commits[e].children}),a=_.filter(n,function(e){var r=t.commits[e];return r.columns&&"m"==r.columns[0]});if(a.length>0)r.name="r"+r.name.substring(1);else{var s=t.commits[r.commits[0]];if(s.children.length>0){var i=_.filter(s.children,function(e){return"d"==t.commits[e].columns[0][0]});i.length>0?r.name="f"+r.name.substring(1):r.firstChild=t.commits[s.children[0]]}else s.labels&&s.labels.filter(function(e){return 0==e.indexOf(o.featurePrefix)}).length>0&&(r.name="f"+r.name.substring(1)),s.labels&&s.labels.filter(function(e){return 0==e.indexOf(o.releasePrefix)||0==e.indexOf(o.hotfixPrefix)||o.releaseZonePattern.test(e)}).length>0?r.name="r"+r.name.substring(1):r.name="f"+r.name.substring(1)}}}for(var l=_.filter(_.map(Object.keys(t.columns),function(e){return t.columns[e]}),function(e){return"c"==e.name[0]});;){for(var c=!1,m=0;m<l.length;m++){var r=l[m];if(r.firstChild){var d=t.columns[r.firstChild.columns[0]],u=d.name[0];"c"!=u&&(r.name=u+r.name.substring(1),delete r.firstChild,c=!0)}}if(!c)break}for(var f=_.filter(_.map(Object.keys(t.columns),function(e){return t.columns[e]}),function(e){return"f"==e.name[0]}),h=_.filter(f,function(e){return e.commits.length>9}),g=1,p=0;p<h.length;p++){var v=h[p];v.group=g,g++}for(var p=0;p<f.length;p++){var v=f[p],s=t.commits[v.commits[0]];if(s.children&&s.children.length>0){var b=t.columns[t.commits[s.children[0]].columns[0]];b.group&&(v.group=b.group)}else{var y=t.commits[v.commits[v.commits.length-1]];if(y.parents&&y.parents.length>0){var w=t.commits[y.parents[0].id];if(w){var x=t.columns[w.columns[0]];x.group&&(v.group=x.group)}}}}},h=function(e){t.columnMappings=t.columnMappings||{};for(var r={},n=_.map(t.columns,function(e){return e}).filter(function(t){return t.name[0]==e}),a={},s=0;s<n.length;s++)n[s].group&&(a[n[s].group]=!0);a=Object.keys(a),a.unshift(null);for(var s=0;s<a.length;s++)for(var o=a[s],i=_.filter(n,function(e){return null===o?"undefined"==typeof e.group:e.group==o}),s=0;s<i.length;s++)for(var l=i[s],c=0;c<s;c++){var m=i[c];if(!(m.id in r)){var d=t.commits[m.commits[m.commits.length-1]];d.parents.length>0&&t.commits[d.parents[0].id]&&(d=t.commits[d.parents[0].id]);var u=t.commits[l.commits[0]];u.children.length>0&&t.commits[u.children[0]]&&(u=t.commits[u.children[0]]),u.orderNr>=d.orderNr&&(t.columnMappings[l.id]=m.id,r[l.id]=!0,c=s)}}},g=function(e,r){t.columns||(t.columns={}),r in t.columns||(t.columns[r]={commits:[],name:r,id:r});var n=t.commits[e];return!!n&&(n.columns=n.columns||[],n.columns.push(r),t.columns[r].commits.push(e),!0)},p=function(e,t){var r=function(e,r){return t.indexOf(r)>-1?1e3:-1},n=v(e,r);return n.asArray()},v=function(r,n){var a=n||function(){return-1},s=[],o={},i=t.commits[r],l=e([r]),c=0;for(l.score=0,o[i.orderNr]=l,c=i.orderNr,s.push(l);s.length>0;)for(var m=s.shift(),d=t.commits[m.last()],u=0;u<d.parents.length;u++){var f=t.commits[d.parents[u].id];if(f){var h=a(m,f.id);if(h!==!1&&!(o[f.orderNr]&&o[f.orderNr].score>m.score+h)){var g=m.clone();g.push(f.id),g.score=m.score+h,s.push(g),o[f.orderNr]=g,c<f.orderNr&&(c=f.orderNr)}}}var p=Object.keys(o);return p.sort(function(e,t){return e&&t?o[t].score-o[e].score:0}),o[p[0]]},b=function(e){var r=o.developRef.substring(o.developRef.lastIndexOf("/")+1),n=o.releasePrefix.split("/")[2],a=o.hotfixPrefix.split("/")[2],s=new RegExp("Merge branch '("+r+")' of http:\\/\\/\\S+ into \\1"),i=new RegExp("Merge branch '[^']+' into "+r+"$"),l=new RegExp("Merge branch '("+n+"|"+a+")[^']+' into "+r+"\\b"),c=function(e,r){var n=t.commits[r],a=t.commits[e.last()];if(n.columns&&"m"==n.columns[0])return!1;var o=n.children.filter(function(t){return t in e.members});return 1==o.length&&(s.test(n.message)?0:l.test(n.message)?20:i.test(n.message)?5:a.parents.length>1&&n.id==a.parents[0].id?1:-.1)},m=v(e,c);return m.asArray()};r.state=function(){var e=JSON.stringify(y);return e};var y=null;r.draw=function(e,t){if(e)try{e instanceof HTMLElement||(t=e,e=null)}catch(r){"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument||(t=e,e=null)}o=_.extend(o,t),o.drawElem=o.drawElem||e,o.drawElem?o.drawElem instanceof d3.selection||(o.drawElem=d3.select(o.drawElem)):o.drawElem=d3.select("body").append("div").attr("id","gitflow-visualize"),o.showSpinner(),o.dataCallback(function(e){y=e,o.hideSpinner(),x()})};var w=function(e){y.commits.push(e)},x=function(){o.showSpinner(),t=setTimeout(function(){i(y),o.hideSpinner(),o.dataProcessed(t),o.drawElem&&(r.drawing.drawTable(o.drawElem),r.drawing.drawGraph(o.drawElem),r.drawing.updateHighlight())},10)};return r.drawing=function(){var e={};e.updateHighlight=function(){var e=function(e){if(!e||0==e.length)return d3.selectAll(".commit-msg").classed("dim",!1).classed("highlight",!1),d3.selectAll(".commit-dot").classed("dim",!1),void d3.selectAll(".arrow").style("opacity","1");for(var r in t.commits)e.indexOf(r)>-1?(d3.selectAll("#msg-"+r).classed("dim",!1).classed("highlight",!0),d3.selectAll("#commit-"+r).classed("dim",!1),d3.selectAll(".arrow-to-"+r).style("opacity","1")):(d3.selectAll("#msg-"+r).classed("dim",!0).classed("highlight",!1),d3.selectAll("#commit-"+r).classed("dim",!0),d3.selectAll(".arrow-to-"+r).style("opacity","0.2"))};switch(d3.selectAll(".commit-msg.selected").classed("selected",!1),n.style){case"none":e([]);break;case"ancestry":var r=d3.select("#msg-"+n.root),a={},s=function(e){var r=t.commits[e];if(r&&!a[e]){a[e]=!0;for(var n=0;n<r.parents.length;n++)s(r.parents[n].id)}};r.classed("selected",!0),s(n.root),e(Object.keys(a))}},e.drawTable=function(e){if(o.drawTable){var n=d3.select(document.createElement("table"));n.append("tr").html(l()+"<td>sha</td><td>parent</td><td>author</td><td>at</td><td>msg</td></tr>");for(var a=0;a<t.chronoCommits.length;a++){var s=t.commits[t.chronoCommits[a]],c=new Date(s.authorTimestamp);n.append("tr").html(i(s)+"<td>"+s.displayId+"</td><td>"+r(s.parents)+"</td><td>"+s.author.name+"</td><td>"+moment(c).format("M/D/YY HH:mm:ss")+"</td><td>"+s.message+"</td>")}d3.select(e).append(n)}};var r=function(e){return _.map(e,function(e){return e.displayId}).join(", ")},s=function(e){var r=_.map(e,function(e,t){return t});return r.sort(firstBy(function(t,r){var n=function(t){return{m:1,d:3,f:4,r:2}[e[t].name[0]]||5};return n(t)-n(r)}).thenBy(function(e,r){return(t.columns[e].group||0)-(t.columns[r].group||0)}).thenBy(function(e,r){if("f"==t.columns[e].name[0]){var n=t.columns[e].commits,a=t.columns[r].commits;return t.commits[n[0]].orderNr-t.commits[a[0]].orderNr}return r>e?-1:1})),r},i=function(e){for(var r="",n=s(t.columns),a=0;a<n.length;a++){var o=n[a];r+="<td>",e.columns.indexOf(o)>-1&&(r+="o"),r+="</td>"}return r},l=function(){for(var e="",r=s(t.columns),n=0;n<r.length;n++){var a=r[n];e+="<td>"+t.columns[a].name+"</td>"}return e},c=function(e,t,r){var n={gutter:.7,line:1,developLine:.4};console.log(e,r);for(var a="",s=0,o={},i=0;i<e.length;i++){var l=e[i],c=l[0];a!=c&&(s+=n.gutter),s+="d"==c?n.developLine:n.line,o[l]=s,a=c}var m=d3.scale.linear().domain([0,s]).range([0,Math.min(t,20*s)]);return function(e){e in r&&(e=r[e]);var t=0;return"+"==e[e.length-1]&&(e=e.substring(0,e.length-1),t=.5),m(o[e]+t)}};e.drawGraph=function(r){function i(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}var l=Math.max(800,t.chronoCommits.length*a.rowHeight),f={width:500,height:l},h=20,g=r.select("svg>g");if(g.empty()){var p=r.append("div");p.attr("class","commits-graph-container");var g=p.append("svg").attr("class","commits-graph").append("g").attr("transform","translate("+h+",0)")}r.select("svg").attr("width",f.width+2*h).attr("height",f.height+2*h);var v=s(t.columns),b={master:{prefix:"m"},releases:{prefix:"r"},develop:{prefix:"d"},features:{prefix:"f"}};for(var y in b){var C=v.filter(function(e){return t.columns[e].name[0]===b[y].prefix});0!=C.length?(b[y].first=C[0],b[y].last=C[C.length-1]):delete b[y]}var N=c(v,f.width,t.columnMappings),A=d3.scale.linear().domain([0,t.chronoCommits.length]).range([60,60+t.chronoCommits.length*a.rowHeight]),E=d3.svg.line().x(function(e){return N(e.x)}).y(function(e){return A(e.y)}),O=function(e){var r=t.commits[e.c],n=t.commits[e.p];if(!r||!n)return null;var a=n.orderNr-.5,s=r.columns[0],o=null,i=null,l=t.columns[r.columns[0]];if(!l)return null;var c=t.columns[n.columns[0]];if(l.id!=c.id){var m=c.commits[c.commits.indexOf(n.id)-1];if(!m||t.commits[m].orderNr<r.orderNr)a=r.orderNr+.5,s=n.columns[0];else{var d=l.commits[l.commits.indexOf(r.id)+1];!d||t.commits[d].orderNr>n.orderNr||(i=r.columns[0]+"+",o=n.orderNr-.5,s=r.columns[0]+"+",a=r.orderNr+.5)}}i||(i=s),o||(o=a);var u=[{x:r.columns[0],y:r.orderNr},{x:s,y:a},{x:i,y:o},{x:n.columns[0],y:n.orderNr}];return E(u)};g.selectAll(".arrow").remove();var z=_.flatMap(d3.values(t.commits),function(e){return e.parents.map(function(t){return{p:t.id,c:e.id}})}),k=g.selectAll(".arrow").data(z);k.enter().append("g").attr("class",function(e){return"arrow arrow-to-"+e.c}),k.append("path").attr("d",O).attr("class","outline"),k.append("path").attr("d",O).attr("class",function(e){return"branch-type-"+u(e.c,e.p)}),g.selectAll(".branch").remove();var T=g.selectAll(".branch").data(d3.values(t.columns)).enter().append("g").attr("class","branch");T.append("line").attr("class",function(e){return"branch-line "+e.name}).attr("x1",function(e){return N(e.id)}).attr("x2",function(e){return N(e.id)}).attr("y1",A(0)).attr("y2",f.height),g.selectAll(".commit").remove();var M=g.selectAll(".commit").data(d3.values(t.commits)).enter().append("g").attr("class","commit");M.append("circle").attr("class","commit-dot").attr("r",5).attr("cx",function(e){return N(e.columns[0])}).attr("cy",function(e){return A(e.orderNr)}).attr("id",function(e){return"commit-"+e.id}),g.selectAll(".legenda-label").remove();var P=g.selectAll(".legenda-label").data(Object.keys(b)).enter().append("g").attr("class",function(e){return"legenda-label "+b[e].prefix}),H=P.append("g").attr("transform",function(e){var t=b[e].first==b[e].last?-10:0;return"translate("+(N(b[e].first)+t)+", "+(A(0)-20)+") rotate(-40)"});H.append("rect").attr("width",60).attr("height",15).attr("rx","2"),H.append("text").attr("y","12").attr("x","3").text(function(e){return e}),P.append("path").attr("d",function(e){var t=b[e];return E([{x:t.first,y:-.3},{x:t.last,y:-.3}])});var D=r.select("div.messages");null==D[0][0]&&(D=r.append("div").attr("class","messages"));var R=D.selectAll(".commit-msg").data(d3.values(t.commits),function(e){return e.id+"-"+e.orderNr});R.enter().append("div").attr("class","commit-msg").attr("id",function(e){return"msg-"+e.id}).on("click",function(t){return"A"==d3.event.target.tagName||("ancestry"==n.style&&t.id==n.root?(n.style="none",n.root=null):(n.style="ancestry",n.root=t.id),void e.updateHighlight())}),R.exit().remove(),R.attr("style",function(e){var t=e;return"top:"+(A(t.orderNr)-a.rowHeight/2)+"px;"}).html(function(e){var t=o.createCommitUrl(e),r="<table class='commit-table aui'><tr><td class='msg'>";if(e.labels&&_.each(e.labels,function(e){r+=0==e.indexOf("refs/heads/")?0==e.indexOf(o.masterRef)?"<span class='label aui-lozenge aui-lozenge-error aui-lozenge-subtle'>"+e.substring(11)+"</span>":0==e.indexOf(o.developRef)?"<span class='label aui-lozenge aui-lozenge-success aui-lozenge-subtle'>"+e.substring(11)+"</span>":0==e.indexOf(o.featurePrefix)?"<span class='label aui-lozenge aui-lozenge-complete aui-lozenge-subtle'>"+e.substring(11)+"</span>":0==e.indexOf(o.releasePrefix)||0==e.indexOf(o.hotfixPrefix)?"<span class='label aui-lozenge aui-lozenge-current aui-lozenge-subtle'>"+e.substring(11)+"</span>":"<span class='label aui-lozenge aui-lozenge-subtle'>"+e.substring(11)+"</span>":0==e.indexOf("refs/tags/")?"<span class='label aui-lozenge aui-lozenge-moved aui-lozenge-subtle'>"+e.substring(10)+"</span>":"<span class='label aui-lozenge aui-lozenge-subtle'>"+e+"</span>"}),r+=" "+e.message,r+="</td>",e.author){var n=o.createAuthorAvatarUrl(e.author);r+="<td class='author'><span class='aui-avatar aui-avatar-xsmall user-avatar'><span class='aui-avatar-inner'><img src='"+n+"' width='48px' height='48px' /></span></span>"+(e.author.displayName||e.author.name||e.author.emailAddress)+"</td>"}else r+="<td class='author'> </td>";if(e.authorTimestamp){var a=new Date(e.authorTimestamp),s=(new Date).toDateString()===a.toDateString();r+=s?"<td class='date'>"+moment(a).format("HH:mm:ss")+" today</td> ":"<td class='date' title='"+moment(a).format("dddd YYYY-MM-DD HH:mm:ss")+"'>"+moment(a).format("dd YYYY-MM-DD")+"</td> "}return r+="<td class='sha'><a class='commit-link' href='"+t+"' target='_blank'>"+e.displayId+"</a></td> ",r+="</tr></table>"}),e.lazyLoad=function(){var e=null;for(var r in t.openEnds){var n=d3.select("#msg-"+r);if(!n.empty()&&i(n.node())){e=r;break}}if(e){var a=t.commits[e].orderNr;for(var r in t.openEnds)if(!(t.commits[r].orderNr>a+200)){for(var s=0;s<t.openEnds[r].length;s++){var l=t.openEnds[r][s];m[l]=!0,console.log("scheduled: "+l)}delete t.openEnds[r]}for(var r in m)console.log("downloading: "+r),delete m[r],d[r]=!0,o.moreDataCallback(r,function(e,t){delete d[t],e&&w(e),0==Object.keys(m).length&&0==Object.keys(d).length?(console.log("queues empty, ready to draw"),setTimeout(function(){x()},50)):(console.log("waiting, still downloads in progress"),console.log(m),console.log(d))});m={}}}};var m={},d={},u=function(e,r){var n=function(e){var r=t.commits[e];if(!r||0==t.columns.length)return"?";var n=r.columns.map(function(e){return t.columns[e]});return n[0].name[0]},a={m:0,d:1,r:3,f:2},s=[n(e),n(r)];return"d"===s[0]&&"d"!==s[1]?s[1]+" back":(s.sort(function(e,t){return a[t]-a[e]}),s[0]||"default")};return e}(),document&&(d3.select(document).on("scroll resize",function(){GitFlowVisualize.drawing.lazyLoad()}),d3.select(document).on("keydown",function(){var e=d3.event;if(e.ctrlKey&&e.shiftKey&&221==e.which){var t=d3.select("#debug-output");t.empty()&&(t=d3.select("body").append("textarea").attr("id","debug-output")),t.style("display",""),t.node().value=GitFlowVisualize.state(),t.node().focus(),t.node().select(),t.on("blur",function(){t.style("display","none")})}})),r}();